<!doctype html>
<html lang="tr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KPSS Puan Arama</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 960px;
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            font-weight: bold;
        }
        .summary-card .card-header {
            background-color: #6c757d;
        }
        /* YENİ EKLENDİ: Iframe başlangıçta gizli olacak */
        #pdfIframeWrapper.d-none {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4">KPSS Taban Puanları Arama Motoru</h2>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="mezuniyetTuru" class="form-label fw-bold">1. Mezuniyet Türü Seçimi</label>
                <select id="mezuniyetTuru" class="form-select">
                    <option selected disabled>Lütfen mezuniyet türü seçiniz...</option>
                    <option value="ortaogretim">Ortaöğretim (Lise)</option>
                    <option value="onlisans">Önlisans</option>
                    <option value="lisans">Lisans</option>
                </select>
            </div>

            <div class="col-md-6 mb-3">
                <label for="mezunProgram" class="form-label fw-bold">2. Mezun Olunan Program Seçimi</label>
                <select id="mezunProgram" class="form-select" disabled>
                    <option selected>Önce mezuniyet türü seçiniz...</option>
                </select>
            </div>
        </div>

        <div id="sonucTablosu" class="mt-4">
            </div>
        
        <div id="pdfIframeWrapper" class="mt-5 d-none">
            <h4 class="text-center mb-3">KPSS Araştırması PDF Formatında</h4>
            <div class="ratio ratio-16x9">
                <iframe id="pdf-iframe" src="OnlinePDR-KPSS-Arastirmasi.pdf" title="PDF Görüntüleyici" allowfullscreen></iframe>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        const veriCache = {
            ortaogretim: null,
            onlisans: null,
            lisans: null
        };

        const mezuniyetTuruSelect = document.getElementById('mezuniyetTuru');
        const mezunProgramSelect = document.getElementById('mezunProgram');
        const sonucTablosuDiv = document.getElementById('sonucTablosu');
        
        // YENİ EKLENDİ: Iframe elementleri
        const pdfIframeWrapper = document.getElementById('pdfIframeWrapper');
        let iframeTimer; // Zamanlayıcıyı tutacak değişken

        // YENİ EKLENDİ: Iframe'i gösteren fonksiyon
        function showIframe() {
            // Eğer zamanlayıcı çalışıyorsa, iptal et (çünkü fonksiyon ya seçimle ya da süre dolunca çağrıldı)
            clearTimeout(iframeTimer);
            // Iframe zaten görünürse tekrar bir işlem yapma
            if (!pdfIframeWrapper.classList.contains('d-none')) {
                return;
            }
            // 'd-none' class'ını kaldırarak iframe'i görünür yap
            pdfIframeWrapper.classList.remove('d-none');
        }

        // YENİ EKLENDİ: Sayfa yüklendiğinde 1 dakikalık zamanlayıcıyı başlat
        iframeTimer = setTimeout(showIframe, 60000); // 60000 milisaniye = 1 dakika

        // 1. Mezuniyet Türü Değiştiğinde Tetiklenir
        mezuniyetTuruSelect.addEventListener('change', async function () {
            const secilenTur = this.value;
            sonucTablosuDiv.innerHTML = ''; 
            mezunProgramSelect.disabled = true;
            mezunProgramSelect.innerHTML = '<option>Yükleniyor...</option>';

            try {
                const programlar = await getProgramVerisi(secilenTur);
                populateProgramSelect(programlar);
                mezunProgramSelect.disabled = false;
            } catch (error) {
                console.error('Veri yüklenirken hata oluştu:', error);
                mezunProgramSelect.innerHTML = '<option>Hata oluştu!</option>';
            }
        });

        // 2. Mezun Olunan Program Değiştiğinde Tetiklenir
        mezunProgramSelect.addEventListener('change', function () {
            // YENİ EKLENDİ: Program seçimi yapıldığı anda iframe'i göster
            showIframe();

            const secilenProgramAdi = this.value;
            const secilenTur = mezuniyetTuruSelect.value;

            if (!secilenProgramAdi || secilenProgramAdi === 'default') {
                sonucTablosuDiv.innerHTML = '';
                return;
            }

            const tumProgramlar = veriCache[secilenTur];
            const secilenProgramVerisi = tumProgramlar.find(p => p['Kod Açıklaması'] === secilenProgramAdi);
            displayTable(secilenProgramVerisi);
        });

        // JSON dosyasını çeken ve cache'leyen fonksiyon
        async function getProgramVerisi(tur) {
            if (veriCache[tur]) {
                return veriCache[tur];
            }
            const response = await fetch(`${tur}.json`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            veriCache[tur] = data; 
            return data;
        }
        
        // Programlar dropdown'ını özel sıralama ile dolduran fonksiyon
        function populateProgramSelect(programlar) {
            mezunProgramSelect.innerHTML = '<option value="default" selected>Lütfen mezun olduğunuz programı seçiniz...</option>';

            const genelProgram = programlar.find(p => p['Kod Açıklaması'].startsWith('Herhangi bir'));
            const digerProgramlar = programlar.filter(p => !p['Kod Açıklaması'].startsWith('Herhangi bir'));

            digerProgramlar.sort((a, b) => a['Kod Açıklaması'].localeCompare(b['Kod Açıklaması'], 'tr'));

            if (genelProgram) {
                const option = document.createElement('option');
                option.value = genelProgram['Kod Açıklaması'];
                option.textContent = genelProgram['Kod Açıklaması'];
                mezunProgramSelect.appendChild(option);
            }
            
            digerProgramlar.forEach(program => {
                const option = document.createElement('option');
                option.value = program['Kod Açıklaması'];
                option.textContent = program['Kod Açıklaması'];
                mezunProgramSelect.appendChild(option);
            });
        }

        // Yıllık tabloya ek olarak "Son 3 Yıl Özeti" tablosunu da ekler
        function displayTable(data) {
            if (!data) {
                sonucTablosuDiv.innerHTML = '<div class="alert alert-warning">Seçilen program için veri bulunamadı.</div>';
                return;
            }

            const yillikTabloHtml = `
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        ${data['Kodlar ']} - ${data['Kod Açıklaması']}
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped table-hover text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th>Yıl</th>
                                        <th>Kontenjan Sayısı</th>
                                        <th>Yerleşen Aday Sayısı</th>
                                        <th>En Düşük Puan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>2024</strong></td>
                                        <td>${data['2024_Kontenjan_Sayısı'] || 'N/A'}</td>
                                        <td>${data['2024_Yerleşen_Aday_Sayısı'] || 'N/A'}</td>
                                        <td>${data['2024_En_Düşük_Puan'] || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>2023</strong></td>
                                        <td>${data['2023_Kontenjan_Sayısı'] || 'N/A'}</td>
                                        <td>${data['2023_Yerleşen_Aday_Sayısı'] || 'N/A'}</td>
                                        <td>${data['2023_En_Düşük_Puan'] || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>2022</strong></td>
                                        <td>${data['2022_Kontenjan_Sayısı'] || 'N/A'}</td>
                                        <td>${data['2022_Yerleşen_Aday_Sayısı'] || 'N/A'}</td>
                                        <td>${data['2022_En_Düşük_Puan'] || 'N/A'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            const ozetTabloHtml = `
                <div class="card shadow-sm summary-card">
                    <div class="card-header">
                        Son Üç Yıl Özeti
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th>Toplam Kontenjan</th>
                                        <th>Toplam Yerleşen</th>
                                        <th>Ortalama Puan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>${data['Son Üç Yıl_Kontenjan_Sayısı'] || 'N/A'}</td>
                                        <td>${data['Son Üç Yıl_Yerleşen_Aday_Sayısı'] || 'N/A'}</td>
                                        <td>${data['Son Üç Yıl_Puan_Ortalaması'] ? parseFloat(data['Son Üç Yıl_Puan_Ortalaması']).toFixed(5) : 'N/A'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            sonucTablosuDiv.innerHTML = yillikTabloHtml + ozetTabloHtml;
        }

    </script>
</body>

</html>